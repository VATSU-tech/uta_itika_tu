<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Valentine ðŸ’˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      background: #ffb8b8;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }

    .container {
      background: rgba(255,255,255,.15);
      padding: 2rem;
      border-radius: 2rem;
      text-align: center;
      box-shadow: 0 0 4rem #ff6767;
    }

    h1 { color: #ff4040; }

    button {
      padding: 1rem 2rem;
      border-radius: 2rem;
      border: none;
      cursor: pointer;
      margin: .5rem;
      font-size: 1rem;
    }

    #yes { background: #ff4040; color: white; }
    #no  { background: #ffd1d1; }

    #export {
      margin-top: 1rem;
      font-size: .8rem;
    }
  </style>
</head>

<body>

<div class="container">
  <h1 id="question"></h1>

  <button id="yes">Oui ðŸ’–</button>
  <button id="no">Non ðŸ˜…</button>

  <br />
  <button id="export">Exporter le JSON</button>
</div>

<script>
/* ================================
   1. Lire les paramÃ¨tres du lien
================================ */
const params = new URLSearchParams(window.location.search);
const to   = params.get("to")   || "Ma Valentine";
const from = params.get("from") || "Quelquâ€™un";

/* ================================
   2. Afficher la question
================================ */
document.getElementById("question").textContent =
  `${to}, veux-tu Ãªtre ma Valentine ðŸ’˜ ?`;

/* ================================
   3. Charger le JSON existant
   (simulation fetch)
================================ */
async function loadResponses() {
  const stored = localStorage.getItem("valentineResponses");
  if (!stored) return {};

  // Simule un fetch depuis un "fichier"
  const blob = new Blob([stored], { type: "application/json" });
  const url  = URL.createObjectURL(blob);

  const res = await fetch(url);
  const json = await res.json();

  URL.revokeObjectURL(url);
  return json;
}

/* ================================
   4. Sauvegarder une rÃ©ponse
================================ */
async function saveResponse(answer) {
  const data = await loadResponses();

  data[to] = {
    from,
    answer,
    date: new Date().toISOString()
  };

  localStorage.setItem(
    "valentineResponses",
    JSON.stringify(data, null, 2)
  );
}

/* ================================
   5. Bouton YES
================================ */
document.getElementById("yes").onclick = async () => {
  await saveResponse("yes");

  document.querySelector(".container").innerHTML =
    `<h1>Merci ${to} ðŸ’–</h1>
     <p>Tu viens de faire battre un cÅ“ur ðŸ«¶</p>`;
};

/* ================================
   6. Bouton NO (fuit ðŸ˜„)
================================ */
document.getElementById("no").onmouseover = e => {
  e.target.style.position = "absolute";
  e.target.style.left = Math.random() * 80 + "%";
  e.target.style.top  = Math.random() * 80 + "%";
};

/* ================================
   7. Quitter sans rÃ©pondre
================================ */
window.addEventListener("beforeunload", async () => {
  const data = await loadResponses();
  if (!data[to]) await saveResponse("left");
});

/* ================================
   8. Export JSON
================================ */
document.getElementById("export").onclick = async () => {
  const data = await loadResponses();

  const blob = new Blob(
    [JSON.stringify(data, null, 2)],
    { type: "application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "valentine-responses.json";
  a.click();
};
</script>

</body>
</html>
